name: 🚀 自动发布Release

on:
  push:
    tags:
      - 'v*'  # 当推送v开头的标签时触发

permissions:
  contents: write  # 需要写权限来创建Release

jobs:
  release:
    name: 创建Release
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4

    - name: 📋 提取版本信息
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: 📦 创建发布包
      run: |
        echo "创建发布包..."

        # 压缩所有内容，排除.git和.github目录
        zip -r "WebBot-${{ steps.version.outputs.version }}.zip" . -x ".git/*" ".github/*"

        # 显示压缩包信息
        ls -lh "WebBot-${{ steps.version.outputs.version }}.zip"

        echo "发布包创建完成！"

    - name: 📝 生成Release说明
      id: release_notes
      run: |
        RELEASE_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        cat > release_notes.md << EOF
        ## 🚀 版本 ${{ steps.version.outputs.version }}
        
        ### 📝 更新内容
        - 🔄 自动发布版本 ${{ steps.version.outputs.version }}
        - ✨ 包含最新的功能和修复
        
        ### 📦 包含内容
        - ✅ **核心系统** - 完整的QQ机器人管理系统
        - ✅ **Web管理界面** - 基于Flask + Tabler的现代化界面
        - ✅ **QQ机器人适配器** - 支持QQ官方机器人API
        - ✅ **插件系统** - 灵活的插件架构，支持热插拔
        - ✅ **用户管理系统** - 完整的用户注册、登录、权限管理
        - ✅ **数据库支持** - SQLite + Redis双重存储
        
        ### 🔌 内置插件
        | 插件名称 | 功能描述 | 状态 |
        |---------|---------|------|
        | **demo** | 演示插件，展示插件开发示例 | ✅ 可用 |
        | **echo** | 回声插件，测试机器人响应 | ✅ 可用 |
        | **help** | 帮助插件，显示可用命令 | ✅ 可用 |
        | **Yapi** | YAPI插件，游戏数据查询 | ✅ 可用 |
        | **RussianRoulette** | 俄罗斯轮盘游戏插件 | ✅ 可用 |
        
        ### 🛠️ 技术栈
        - **后端**: Python 3.10+ / Flask
        - **前端**: Tabler UI Framework
        - **数据库**: SQLite + Redis
        - **机器人**: QQ官方机器人API
        - **部署**: Gunicorn + Nginx
        
        ### 🔐 安全特性
        - ✅ **权限管理** - 多级用户权限系统
        - ✅ **数据加密** - 敏感数据加密存储
        - ✅ **API验证** - QQ机器人签名验证
        - ✅ **会话管理** - 安全的用户会话
        - ✅ **输入验证** - 严格的数据验证机制
        
        ### ⚠️ 注意事项
        - 需要Python 3.10或更高版本
        - 建议使用虚拟环境安装依赖
        - 生产环境请使用HTTPS
        - 定期备份数据库文件
        
        ### 🆕 版本特色
        - 🎨 **现代化界面** - 基于Tabler的美观UI
        - 🔌 **插件热插拔** - 无需重启即可启用/禁用插件
        - 📊 **实时监控** - 系统状态和机器人运行监控
        - 🛡️ **安全加固** - 多重安全防护机制
        - 🚀 **高性能** - 优化的代码结构和执行效率
        
        ---
        
        ### 💝 感谢使用
        
        如果这个项目对您有帮助，请给个⭐️支持一下！
        
        **发布时间**: $RELEASE_TIME
        **构建版本**: ${{ github.sha }}
        EOF
        
    - name: 🎁 创建Release并上传文件
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "创建Release并上传压缩包..."

        gh release create ${{ steps.version.outputs.version }} \
          --title "🚀 Release ${{ steps.version.outputs.version }}" \
          --notes-file release_notes.md \
          --latest \
          "WebBot-${{ steps.version.outputs.version }}.zip"

        echo "Release创建完成，压缩包已上传！"
        
    - name: 📢 发布成功通知
      run: |
        echo "🎉 Release ${{ steps.version.outputs.version }} 创建成功！"
        echo "📦 访问地址: https://github.com/Yixuan997/WebBot/releases/tag/${{ steps.version.outputs.version }}"
        echo "💾 已上传编译后的项目包: WebBot-${{ steps.version.outputs.version }}.zip"
        echo "🔄 现在支持一键热更新功能！"
