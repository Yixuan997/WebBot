{% extends "admin/base.html" %}

{% block title %}{{ workflow.name }} - å·¥ä½œæµè¯¦æƒ… - {{ system.title }}{% endblock %}
{% block page_title %}å·¥ä½œæµè¯¦æƒ…{% endblock %}

{% block content %}
{% set trigger_type = config.get('trigger_type', 'message') %}
<form id="basicInfoForm" onsubmit="saveBasicInfo(event)">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">åŸºæœ¬ä¿¡æ¯</h3>
            <div class="card-actions">
                {% if workflow.enabled %}
                <span class="badge bg-success-lt">å·²å¯ç”¨</span>
                {% else %}
                <span class="badge bg-secondary-lt">å·²ç¦ç”¨</span>
                {% endif %}
                {% if trigger_type == 'schedule' %}
                <span class="badge bg-orange-lt">â° å®šæ—¶è§¦å‘</span>
                {% else %}
                <span class="badge bg-blue-lt">ğŸ’¬ æ¶ˆæ¯è§¦å‘</span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <label class="form-label">åç§°</label>
                    <input type="text" class="form-control" name="name" value="{{ workflow.name }}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ä¼˜å…ˆçº§</label>
                    <input type="number" class="form-control" name="priority" value="{{ workflow.priority }}" min="0" max="999">
                    <small class="form-hint">æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ</small>
                </div>
                <div class="col-12">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-control" name="description" rows="2" placeholder="å¯é€‰">{{ workflow.description or '' }}</textarea>
                </div>
                <div class="col-12">
                    <label class="form-label">åè®®é™åˆ¶</label>
                    <div>
                        {% set protocols = config.get('protocols', []) %}
                        <label class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="protocol_qq" value="qq" {% if 'qq' in protocols %}checked{% endif %}>
                            <span class="form-check-label">QQå®˜æ–¹</span>
                        </label>
                        <label class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="protocol_onebot" value="onebot" {% if 'onebot' in protocols %}checked{% endif %}>
                            <span class="form-check-label">OneBot</span>
                        </label>
                        <small class="text-muted ms-2">ä¸é€‰åˆ™æ”¯æŒæ‰€æœ‰åè®®</small>
                    </div>
                </div>
                
                <!-- å®šæ—¶é…ç½®ï¼ˆä»…å®šæ—¶è§¦å‘ç±»å‹æ˜¾ç¤ºï¼‰ -->
                {% if trigger_type == 'schedule' %}
                <div class="col-md-6">
                    <label class="form-label">è°ƒåº¦ç±»å‹</label>
                    <select class="form-select" name="schedule_type" id="scheduleType" onchange="toggleScheduleFields()">
                        <option value="cron" {% if config.get('schedule', {}).get('type', 'cron') == 'cron' %}selected{% endif %}>Cron è¡¨è¾¾å¼</option>
                        <option value="interval" {% if config.get('schedule', {}).get('type') == 'interval' %}selected{% endif %}>å›ºå®šé—´éš”</option>
                    </select>
                </div>
                <div class="col-md-6" id="cronField">
                    <label class="form-label">Cron è¡¨è¾¾å¼</label>
                    <input type="text" class="form-control" name="schedule_cron" value="{{ config.get('schedule', {}).get('cron', '0 8 * * *') }}" placeholder="åˆ† æ—¶ æ—¥ æœˆ å‘¨">
                    <small class="form-hint">ä¾‹å¦‚ "0 8 * * *" è¡¨ç¤ºæ¯å¤© 08:00</small>
                </div>
                <div class="col-md-6" id="intervalField" style="display: none;">
                    <label class="form-label">é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" class="form-control" name="schedule_interval" value="{{ config.get('schedule', {}).get('interval_minutes', 60) }}" min="1" max="1440">
                    <small class="form-hint">1-1440 åˆ†é’Ÿ</small>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="text-muted small d-none d-md-block">
                åˆ›å»ºäº {{ workflow.created_at.strftime('%Y-%m-%d %H:%M') if workflow.created_at else 'æœªçŸ¥' }}
                {% if workflow.updated_at %}Â· æ›´æ–°äº {{ workflow.updated_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
            </div>
            <div class="btn-list ms-auto">
                <a href="{{ url_for('Admin.workflow_list') }}" class="btn btn-outline-secondary">è¿”å›</a>
                <a href="{{ url_for('Admin.workflow_edit', workflow_id=workflow.id) }}" class="btn btn-primary">ç¼–è¾‘</a>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    const triggerType = '{{ config.get("trigger_type", "message") }}';
    
    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
        if (triggerType === 'schedule') {
            toggleScheduleFields();
        }
    });
    
    // å®šæ—¶å­—æ®µåˆ‡æ¢
    function toggleScheduleFields() {
        const scheduleType = document.getElementById('scheduleType');
        if (!scheduleType) return;
        
        const cronField = document.getElementById('cronField');
        const intervalField = document.getElementById('intervalField');
        
        if (scheduleType.value === 'cron') {
            cronField.style.display = 'block';
            intervalField.style.display = 'none';
        } else {
            cronField.style.display = 'none';
            intervalField.style.display = 'block';
        }
    }
    
    // ä¿å­˜åŸºæœ¬ä¿¡æ¯
    function saveBasicInfo(event) {
        event.preventDefault();
        const formEl = document.getElementById('basicInfoForm');
        const formData = new FormData(formEl);
        // æ”¶é›†åè®®
        const protocols = [];
        if (formData.get('protocol_qq')) protocols.push('qq');
        if (formData.get('protocol_onebot')) protocols.push('onebot');
        
        const data = {
            name: formData.get('name'),
            description: formData.get('description') || '',
            priority: parseInt(formData.get('priority')) || 0,
            protocols: protocols
        };
        
        // å®šæ—¶é…ç½®
        if (triggerType === 'schedule') {
            data.schedule_type = formData.get('schedule_type');
            data.schedule_cron = formData.get('schedule_cron');
            data.schedule_interval = parseInt(formData.get('schedule_interval')) || 60;
        }
        
        // é€šè¿‡è¡¨å•æäº¤
        const submitForm = document.createElement('form');
        submitForm.method = 'POST';
        submitForm.action = `/admin/workflows/{{ workflow.id }}/update-basic`;
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'data';
        input.value = JSON.stringify(data);
        submitForm.appendChild(input);
        
        document.body.appendChild(submitForm);
        submitForm.submit();
    }
</script>
{% endblock %}
