{% extends "admin/base.html" %}

{% block title %}ç¼–è¾‘å·¥ä½œæµ - {{ system.title }}{% endblock %}
{% block page_title %}ç¼–è¾‘å·¥ä½œæµ: {{ workflow.name }}{% endblock %}

{% block content %}
<form id="workflowForm" onsubmit="submitWorkflow(event)">
    <!-- å·¥ä½œæµèŠ‚ç‚¹é…ç½® -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ workflow.name }}</h3>
            <div class="card-actions">
                <button type="button" class="btn btn-sm btn-outline-cyan me-1" onclick="loadDebugRecord()" title="åŠ è½½æœ€è¿‘ä¸€æ¬¡æ‰§è¡Œçš„è°ƒè¯•ä¿¡æ¯">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 9v-1a3 3 0 0 1 6 0v1" /><path d="M8 9h8a6 6 0 0 1 1 3v3a5 5 0 0 1 -10 0v-3a6 6 0 0 1 1 -3" /></svg>
                    è°ƒè¯•
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="addNode()">
                    <svg class="icon" fill="none" height="16" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16"><path d="M0 0h24v24H0z" fill="none" stroke="none"/><path d="M12 5l0 14"/><path d="M5 12l14 0"/></svg>
                    æ·»åŠ 
                </button>
                <button type="submit" class="btn btn-sm btn-primary me-1">
                    <svg class="icon" fill="none" height="16" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16"><path d="M0 0h24v24H0z" fill="none" stroke="none"/><path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/><path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/></svg>
                    ä¿å­˜
                </button>
                <a href="{{ url_for('Admin.workflow_detail', workflow_id=workflow.id) }}" class="btn btn-sm btn-outline-secondary">å–æ¶ˆ</a>
            </div>
        </div>
        <div class="card-body">
            <div id="nodesList" class="list-group list-group-flush">
                <div class="empty">
                    <p class="empty-title">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•èŠ‚ç‚¹</p>
                    <p class="empty-subtitle text-muted">ç‚¹å‡»"æ·»åŠ èŠ‚ç‚¹"å¼€å§‹æ„å»ºå·¥ä½œæµ</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/Sortable.min.js') }}/"></script>
<script>
const availableNodes = {{ available_nodes|tojson }};
const existingWorkflow = {{ config.get('workflow', [])|tojson }};
const existingProtocols = {{ config.get('protocols', [])|tojson }};
const workflowId = {{ workflow.id }};
{% raw %}
let nodeCounter = 1;
const nodes = [];
let sortable = null;
let debugRecord = null;  // è°ƒè¯•è®°å½•

// åˆå§‹åŒ–: åŠ è½½ç°æœ‰èŠ‚ç‚¹
window.addEventListener('DOMContentLoaded', () => {
    let maxNodeNum = 0;
    
    existingWorkflow.forEach(existingNode => {
        const nodeId = existingNode.id || `node_${nodeCounter++}`;
        nodes.push({
            id: nodeId,
            type: existingNode.type,
            config: existingNode.config || {}
        });
        
        // æå–èŠ‚ç‚¹IDä¸­çš„æ•°å­—ï¼Œæ‰¾åˆ°æœ€å¤§å€¼
        const match = nodeId.match(/^node_(\d+)$/);
        if (match) {
            const num = parseInt(match[1], 10);
            if (num > maxNodeNum) maxNodeNum = num;
        }
    });
    
    // è®¡æ•°å™¨ä»æœ€å¤§èŠ‚ç‚¹å·+1å¼€å§‹ï¼Œé¿å…IDé‡å¤
    nodeCounter = maxNodeNum + 1;
    
    renderNodes();
    
    // äº‹ä»¶å§”æ‰˜ï¼šç‚¹å‡»è¾“å…¥è¾“å‡ºæ ‡ç­¾å¤åˆ¶å˜é‡å
    document.getElementById('nodesList').addEventListener('click', (e) => {
        const tag = e.target.closest('.io-tag');
        if (tag && tag.dataset.var) {
            const varName = `{{${tag.dataset.var}}}`;
            navigator.clipboard.writeText(varName).then(() => {
                showToast(`å·²å¤åˆ¶: ${varName}`, 'success');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥', 'danger');
            });
        }
    });
});

// èŠ‚ç‚¹åˆ†ç±»é…ç½®
const categoryConfig = {
    'trigger': { name: 'è§¦å‘å™¨', icon: 'âš¡', color: '#f59f00' },
    'logic': { name: 'é€»è¾‘æ§åˆ¶', icon: 'ğŸ”€', color: '#ae3ec9' },
    'data': { name: 'æ•°æ®å¤„ç†', icon: 'ğŸ“Š', color: '#206bc4' },
    'action': { name: 'æ¶ˆæ¯åŠ¨ä½œ', icon: 'ğŸ“¨', color: '#2fb344' },
    'other': { name: 'å…¶ä»–', icon: 'ğŸ“¦', color: '#666' }
};

// åˆ†ç±»æ˜ å°„ï¼ˆåˆå¹¶ç›¸ä¼¼åˆ†ç±»ï¼‰
const categoryMapping = {
    'trigger': 'trigger',
    'logic': 'logic',
    'control': 'logic',      // æµç¨‹æ§åˆ¶ -> é€»è¾‘æ§åˆ¶
    'data': 'data',
    'network': 'data',       // ç½‘ç»œè¯·æ±‚ -> æ•°æ®å¤„ç†
    'action': 'action',
    'time': 'other',         // æ—¶é—´ -> å…¶ä»–
    'advanced': 'other',     // é«˜çº§ -> å…¶ä»–
    'utility': 'other',      // å·¥å…· -> å…¶ä»–
    'core': 'other'          // æ ¸å¿ƒ -> å…¶ä»–
};

// Tabler èƒŒæ™¯è‰²æ˜ å°„ï¼ˆç”¨äºå¤´åƒåº•è‰²ï¼‰
const categoryBgClass = {
    'trigger': 'bg-yellow-lt',
    'logic': 'bg-purple-lt',
    'data': 'bg-blue-lt',
    'action': 'bg-green-lt',
    'other': 'bg-secondary-lt'
};

function addNode() {
    // è¿‡æ»¤æ‰ start å’Œ end èŠ‚ç‚¹
    const filteredNodes = availableNodes.filter(node => node.type !== 'start' && node.type !== 'end');
    
    // æŒ‰åˆ†ç±»åˆ†ç»„ï¼ˆä½¿ç”¨æ˜ å°„åçš„åˆ†ç±»ï¼‰
    const nodesByCategory = {};
    filteredNodes.forEach(node => {
        const originalCat = node.category || 'other';
        const cat = categoryMapping[originalCat] || 'other';
        if (!nodesByCategory[cat]) nodesByCategory[cat] = [];
        nodesByCategory[cat].push(node);
    });
    
    // åˆ†ç±»é¡ºåº
    const categoryOrder = ['trigger', 'logic', 'data', 'action', 'other'];
    
    // ç”Ÿæˆåˆ†ç±»åˆ—è¡¨å†…å®¹
    const contentHtml = categoryOrder.map(cat => {
        if (!nodesByCategory[cat] || nodesByCategory[cat].length === 0) return '';
        const config = categoryConfig[cat] || { name: cat, icon: 'ğŸ“¦', color: '#666' };
        const listHtml = nodesByCategory[cat].map(node => {
            const originalIdx = availableNodes.findIndex(n => n.type === node.type);
            return `<a class="list-group-item list-group-item-action" href="#" onclick="selectNodeType(${originalIdx}); return false;">
                ${node.icon || 'ğŸ“¦'} ${node.name}
                <small class="text-muted d-block">${node.description || ''}</small>
            </a>`;
        }).join('');
        return `
            <div class="mb-3">
                <div class="subheader mb-2">${config.icon} ${config.name}</div>
                <div class="list-group list-group-flush">${listHtml}</div>
            </div>`;
    }).join('');
    
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div class="modal modal-blur fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">é€‰æ‹©èŠ‚ç‚¹ç±»å‹</h5>
                        <button type="button" class="btn-close" onclick="this.closest('.modal').parentNode.remove()"></button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        ${contentHtml}
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    `;
    document.body.appendChild(modal);
}

// é€‰ä¸­èŠ‚ç‚¹ç±»å‹å¹¶åˆ›å»º
function selectNodeType(nodeIndex) {
    // å…³é—­å¼¹çª—
    document.querySelector('.modal').parentNode.remove();
    
    // åˆ›å»ºèŠ‚ç‚¹
    const nodeTemplate = availableNodes[nodeIndex];
    const nodeId = `node_${nodeCounter++}`;
    const node = {
        id: nodeId,
        type: nodeTemplate.type,
        config: {}
    };
    
    // åˆå§‹åŒ–é»˜è®¤å€¼
    (nodeTemplate.config_schema || []).forEach(field => {
        node.config[field.name] = field.default !== undefined ? field.default : '';
    });
    
    // æ’å…¥åˆ° End èŠ‚ç‚¹ä¹‹å‰
    const endNodeIndex = nodes.findIndex(n => n.type === 'end');
    if (endNodeIndex !== -1) {
        nodes.splice(endNodeIndex, 0, node);
    } else {
        nodes.push(node);
    }
    
    renderNodes();
}

function renderNodes() {
    const container = document.getElementById('nodesList');
    
    if (nodes.length === 0) {
        container.innerHTML = `
            <div class="empty">
                <p class="empty-title">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•èŠ‚ç‚¹</p>
                <p class="empty-subtitle text-muted">ç‚¹å‡»"æ·»åŠ èŠ‚ç‚¹"å¼€å§‹æ„å»ºå·¥ä½œæµ</p>
            </div>
        `;
        return;
    }
    
    // æ¸²æŸ“èŠ‚ç‚¹åˆ—è¡¨
    container.innerHTML = `<div class="nodes-wrapper">${nodes.map((node, index) => {
        const nodeTemplate = availableNodes.find(n => n.type === node.type);
        if (!nodeTemplate) return ''; 

        // === ä¼˜åŒ–é…ç½®é¡¹æ˜¾ç¤º (Label è€Œä¸æ˜¯ Key) ===
        const configItemsList = Object.entries(node.config).map(([key, value]) => {
            // æŸ¥æ‰¾å­—æ®µå®šä¹‰
            const field = (nodeTemplate.config_schema || []).find(f => f.name === key);
            const label = field ? field.label : key;
            
            // å¤„ç†æ˜¾ç¤ºå€¼
            let displayValue = value;
            
            // å¤„ç†è·³è½¬å­—æ®µæ˜¾ç¤º
            if (['true_next', 'false_next', 'true_branch', 'false_branch', 'next_node', 'loop_body'].includes(key)) {
                if (!value) {
                    displayValue = key.startsWith('false') ? 'ä¸è·³è½¬(ä¸­æ–­)' : 'ä¸è·³è½¬(ç»§ç»­)';
                } else {
                    const target = nodes.find(n => n.id === value);
                    if (target) {
                        const targetTmpl = availableNodes.find(t => t.type === target.type);
                        displayValue = targetTmpl ? targetTmpl.name : value;
                    }
                }
            } else if (key === 'snippet_name' && value) {
                // ä»£ç ç‰‡æ®µæ˜¾ç¤ºæ–‡ä»¶åï¼ˆå»æ‰.pyåç¼€ï¼‰
                displayValue = value.replace('.py', '');
            } else if (field && field.type === 'select' && field.options) {
                const opt = field.options.find(o => o.value === value);
                if (opt) displayValue = opt.label;
            }
            
            // æˆªæ–­é•¿æ–‡æœ¬
            displayValue = String(displayValue).length > 50 ? String(displayValue).substring(0, 50) + '...' : displayValue;
            
            return `<div class="text-muted" style="padding-left: 24px; margin-top: 6px; font-size: 13px;">â”œâ”€ <strong>${label}:</strong> <code class="ms-1 bg-light px-1" style="font-size: 13px;">${displayValue}</code></div>`;
        });
        
        // å¯æŠ˜å é…ç½®é¡¹ï¼ˆé»˜è®¤å…¨éƒ¨æŠ˜å ï¼‰
        const configItems = configItemsList.length > 0 
            ? `<div class="config-collapsed" onclick="toggleConfigExpand(this, event)" style="cursor: pointer;">
                <div class="config-toggle" style="padding-left: 24px; margin-top: 6px; font-size: 12px; color: #206bc4;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" style="vertical-align: -2px;"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg>
                    å±•å¼€é…ç½® (${configItemsList.length}é¡¹)
                </div>
                <div class="config-full" style="display: none;">${configItemsList.join('')}</div>
               </div>`
            : '';
        
        // ç”Ÿæˆè¾“å…¥è¾“å‡ºæ ‡ç­¾
        const inputTags = (nodeTemplate.inputs || []).map(input => {
            const requiredMark = input.required ? '<span class="text-red">*</span>' : '';
            return `<span class="badge bg-green-lt me-1 mb-1 io-tag" data-var="${input.name}" style="font-size: 11px; cursor: pointer;" title="ç‚¹å‡»å¤åˆ¶: {{${input.name}}}">ğŸ“¥ ${input.label}${requiredMark}</span>`;
        }).join('');
        
        const outputTags = (nodeTemplate.outputs || []).map(output => {
            return `<span class="badge bg-blue-lt me-1 mb-1 io-tag" data-var="${output.name}" style="font-size: 11px; cursor: pointer;" title="ç‚¹å‡»å¤åˆ¶: {{${output.name}}}">ğŸ“¤ ${output.label}</span>`;
        }).join('');
        
        const ioTags = (inputTags || outputTags) ? `<div style="padding-left: 24px; margin-top: 8px; line-height: 2;">${inputTags}${outputTags}</div>` : '';
        
        const isLast = index === nodes.length - 1;
        const lineChar = isLast ? 'â””â”€â”€' : 'â”œâ”€â”€';
        const isSystemNode = ['start', 'end'].includes(node.type);
        
        // è·å–è°ƒè¯•ä¿¡æ¯
        const debugInfo = getNodeDebugInfo(node.id);
        const debugBorderStyle = debugInfo ? (debugInfo.status === 'success' ? 'border-left: 3px solid #2fb344;' : 'border-left: 3px solid #d63939;') : '';
        const debugHtml = debugInfo ? renderDebugInfo(debugInfo) : '';
        
        // æ“ä½œæŒ‰é’® - EndèŠ‚ç‚¹å¯ä»¥ç¼–è¾‘ï¼ŒStartèŠ‚ç‚¹ä¸å¯ä»¥
        const editButton = (node.type !== 'start') ? `
            <button type="button" class="btn btn-sm btn-ghost-primary btn-icon" onclick="editNode(${index})" title="ç¼–è¾‘" style="width:24px;height:24px;min-width:0;padding:0;">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"/><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"/><path d="M16 5l3 3"/></svg>
            </button>
        ` : '';
        
        const deleteButton = !isSystemNode ? `
            <button type="button" class="btn btn-sm btn-ghost-danger btn-icon" onclick="deleteNode(${index})" title="åˆ é™¤" style="width:24px;height:24px;min-width:0;padding:0;">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0"/><path d="M10 11l0 6"/><path d="M14 11l0 6"/><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/></svg>
            </button>
        ` : '';
        
        return `
            <div class="node-item" data-index="${index}" data-node-type="${node.type}" style="margin-bottom: 12px;">
                <div class="d-flex align-items-start">
                    <div class="d-none d-sm-block" style="color: #6c7a91; font-size: 18px; line-height: 22px; margin-right: 8px; flex-shrink: 0; user-select: none; cursor: ${!isSystemNode ? 'grab' : 'default'};">${lineChar}</div>
                    <div class="card flex-fill" style="box-shadow: 0 1px 2px rgba(0,0,0,0.08); border: 1px solid #e6e7e9; ${debugBorderStyle}">
                        <div class="card-body p-2 p-sm-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-fill" style="min-width: 0;">
                                    <div class="d-flex align-items-center flex-wrap">
                                        <span class="badge me-2" style="background-color: ${index === 0 ? '#2fb344' : (isLast ? '#d63939' : '#206bc4')}; color: white;">${index + 1}</span>
                                        <strong>${nodeTemplate.name}</strong>
                                        <span class="badge bg-secondary-lt ms-2" style="font-size: 11px;">[${node.type}:${node.id}]</span>
                                    </div>
                                </div>
                                <div style="flex-shrink: 0;">
                                    ${editButton}
                                    ${deleteButton}
                                </div>
                            </div>
                            ${debugHtml}
                            ${configItems}
                            ${ioTags}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('')}</div>`;
    
    // åˆå§‹åŒ– SortableJS
    const nodesContainer = container.querySelector('.nodes-wrapper'); // ç»‘å®šåˆ° wrapper
    if (nodesContainer) {
        if (sortable) sortable.destroy();
        sortable = new Sortable(nodesContainer, {
            animation: 150,
            handle: '.card',
            draggable: '.node-item',
            filter: '[data-node-type="start"], [data-node-type="end"]',
            onMove: function(evt) {
                return evt.related.getAttribute('data-node-type') !== 'start' && 
                       evt.related.getAttribute('data-node-type') !== 'end';
            },
            onEnd: function(evt) {
                if (evt.oldIndex !== evt.newIndex) {
                    const item = nodes.splice(evt.oldIndex, 1)[0];
                    nodes.splice(evt.newIndex, 0, item);
                    renderNodes();
                }
            }
        });
    }
}

function editNode(index) {
    const node = nodes[index];
    const nodeTemplate = availableNodes.find(n => n.type === node.type);
    
    const fieldsHtml = (nodeTemplate.config_schema || []).map(field => {
        const value = node.config[field.name] !== undefined ? node.config[field.name] : (field.default || '');
        let inputHtml = '';
        
        // ç¡®å®šå­—æ®µçš„æ˜¾ç¤ºç±»åï¼ˆç”¨äºæ¡ä»¶èŠ‚ç‚¹çš„æ¨¡å¼åˆ‡æ¢ï¼‰
        let fieldClass = 'mb-3';
        let dataMode = ''; // ç”¨äºæ ‡è¯†å­—æ®µæ‰€å±æ¨¡å¼
        let dataShowIf = ''; // ç”¨äº show_if æ¡ä»¶æ˜¾ç¤º
        
        // å¤„ç† show_if æ¡ä»¶
        if (field.show_if) {
            dataShowIf = `data-show-if='${JSON.stringify(field.show_if)}'`;
        }
        
        if (node.type === 'condition') {
            // ç®€å•æ¨¡å¼ä¸“å±å­—æ®µ
            if (['variable_name', 'condition_type', 'compare_value'].includes(field.name)) {
                dataMode = 'data-condition-mode="simple"';
            }
            // é«˜çº§æ¨¡å¼ä¸“å±å­—æ®µ
            else if (['logic_type', 'conditions'].includes(field.name)) {
                dataMode = 'data-condition-mode="advanced"';
            }
            // mode å’Œè·³è½¬å­—æ®µæ˜¯å…±ç”¨çš„ï¼Œä¸éœ€è¦æ ‡è®°
        }
        
        // === ä¸‹æ‹‰æ¡†é€»è¾‘ (åŒ…å«è·³è½¬) ===
        if (field.type === 'select') {
            if (['true_next', 'false_next', 'true_branch', 'false_branch', 'next_node', 'loop_body'].includes(field.name)) {
                // è·³è½¬å­—æ®µ -> èŠ‚ç‚¹åˆ—è¡¨
                const nodeOptions = nodes.map((n, idx) => {
                    const nTemplate = availableNodes.find(t => t.type === n.type);
                    if (n.id === node.id || n.type === 'start') return ''; // è¿‡æ»¤è‡ªèº«å’ŒStart
                    // æ˜¾ç¤ºèŠ‚ç‚¹åç§°å’ŒID
                    return `<option value="${n.id}" ${value === n.id ? 'selected' : ''}>${nTemplate ? nTemplate.name : n.type} (${n.id})</option>`;
                }).join('');
                
                const defaultLabel = field.name === 'loop_body' ? 'è¯·é€‰æ‹©å¾ªç¯ä½“èŠ‚ç‚¹' : (field.name.startsWith('false') ? 'ä¸è·³è½¬(ä¸­æ–­æµç¨‹)' : 'ä¸è·³è½¬(ç»§ç»­æ‰§è¡Œ)');
                inputHtml = `<select class="form-select" id="field_${field.name}"><option value="">${defaultLabel}</option>${nodeOptions}</select>`;
            } else if (field.name === 'snippet_name') {
                // ä»£ç ç‰‡æ®µ
                inputHtml = `<select class="form-select" id="field_${field.name}" onchange="showSnippetMetadata(this.value)"><option value="">åŠ è½½ä¸­...</option></select>
                             <div id="snippet_metadata_info" class="mt-3 p-3 bg-light rounded" style="display: none;">
                                 <div class="row g-2">
                                     <div class="col-12"><strong>æ–‡ä»¶:</strong> <span id="snippet_filename">-</span></div>
                                     <div class="col-12"><strong>ç®€ä»‹:</strong> <span id="snippet_description">-</span></div>
                                     <div class="col-6"><strong>ä½œè€…:</strong> <span id="snippet_author">-</span></div>
                                     <div class="col-6"><strong>ç‰ˆæœ¬:</strong> <span id="snippet_version">-</span></div>
                                 </div>
                             </div>`;
                setTimeout(() => loadSnippets(field.name, value), 100);
            } else {
                // æ™®é€šä¸‹æ‹‰æ¡†
                const options = (field.options || []).map(opt => 
                    `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>`
                ).join('');
                // æ·»åŠ  onchange äº‹ä»¶
                let onChange = '';
                if (node.type === 'condition' && field.name === 'mode') {
                    onChange = 'onchange="toggleConditionMode(this.value)"';
                } else {
                    // é€šç”¨ï¼šä¸‹æ‹‰æ¡†å˜åŒ–æ—¶æ›´æ–° show_if å­—æ®µ
                    onChange = `onchange="updateShowIfFields({${field.name}: this.value})"`;
                }
                inputHtml = `<select class="form-select" id="field_${field.name}" ${onChange}>${options}</select>`;
            }
        } else if (field.type === 'variable_select') {
            // å˜é‡é€‰æ‹©å™¨ (çº¯ä¸‹æ‹‰æ¡†)
            const variables = [];
            
            // éå†å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹ï¼Œæ”¶é›†è¾“å‡ºå˜é‡
            for (let i = 0; i < index; i++) {
                const prevNode = nodes[i];
                const prevTemplate = availableNodes.find(n => n.type === prevNode.type);
                
                // 1. æ”¶é›†èŠ‚ç‚¹å®šä¹‰çš„ outputs
                if (prevTemplate && prevTemplate.outputs) {
                    prevTemplate.outputs.forEach(out => {
                        variables.push({name: out.name, label: `${prevTemplate.name} â†’ ${out.label}`, source: prevNode.id});
                    });
                }
                
                // 2. æ”¶é›†èŠ‚ç‚¹ config.save_to è‡ªå®šä¹‰ä¿å­˜çš„å˜é‡
                if (prevNode.config && prevNode.config.save_to) {
                    const saveTo = prevNode.config.save_to;
                    // é¿å…é‡å¤æ·»åŠ 
                    if (!variables.find(v => v.name === saveTo)) {
                        variables.push({name: saveTo, label: `${prevTemplate ? prevTemplate.name : prevNode.type} â†’ ${saveTo}`, source: prevNode.id});
                    }
                }
            }
            
            // ç”Ÿæˆ Select é€‰é¡¹
            const optionsHtml = variables.map(v => {
                return '<option value="' + v.name + '" ' + (value === v.name ? 'selected' : '') + '>' + v.label + '</option>';
            }).join('');
            
            // æ·»åŠ é»˜è®¤ç©ºé€‰é¡¹
            const finalOptions = `<option value="">è¯·é€‰æ‹©å˜é‡...</option>` + optionsHtml;
            
            inputHtml = `<select class="form-select" id="field_${field.name}">${finalOptions}</select>`;
        } else if (field.type === 'textarea') {
            inputHtml = `<textarea class="form-control" id="field_${field.name}" rows="3">${value}</textarea>`;
        } else if (field.type === 'checkbox') {
            inputHtml = `
                <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="field_${field.name}" ${value ? 'checked' : ''}>
                </label>`;
        } else {
            inputHtml = `<input type="text" class="form-control" id="field_${field.name}" value="${value}" placeholder="${field.placeholder || ''}">`;
        }
        
        // æ¸²æŸ“ help_extra ä¸ºæ ‡ç­¾
        let helpExtraHtml = '';
        if (field.help_extra && field.help_extra.length > 0) {
            helpExtraHtml = field.help_extra.map(extra => {
                const badges = extra.values.map(v => `<span class="badge bg-secondary-lt me-1 mb-1">${v}</span>`).join('');
                return `<div class="mt-2"><small class="text-muted">${extra.label}:</small><div class="mt-1">${badges}</div></div>`;
            }).join('');
        }
        
        return `
            <div class="${fieldClass}" ${dataMode} ${dataShowIf}>
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${inputHtml}
                ${field.help ? `<small class="form-hint">${field.help}</small>` : ''}
                ${helpExtraHtml}
            </div>
        `;
    }).join('');
    
    // Modal
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div class="modal modal-blur fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ç¼–è¾‘èŠ‚ç‚¹: ${nodeTemplate.name}</h5>
                        <button type="button" class="btn-close" onclick="this.closest('.modal').parentNode.remove()"></button>
                    </div>
                    <div class="modal-body">${fieldsHtml}</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-link link-secondary" onclick="this.closest('.modal').parentNode.remove()">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary ms-auto" onclick="saveNode(${index}); this.closest('.modal').parentNode.remove();">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    `;
    document.body.appendChild(modal);
    
    // å¦‚æœæ˜¯æ¡ä»¶èŠ‚ç‚¹ï¼Œåˆå§‹åŒ–å­—æ®µæ˜¾ç¤ºçŠ¶æ€
    if (node.type === 'condition') {
        setTimeout(() => {
            const currentMode = node.config.mode || 'simple';
            toggleConditionMode(currentMode);
        }, 0);
    }
    
    // åˆå§‹åŒ– show_if æ¡ä»¶å­—æ®µæ˜¾ç¤º
    setTimeout(() => updateShowIfFields(node.config), 0);
}

function saveNode(index) {
    const node = nodes[index];
    const nodeTemplate = availableNodes.find(n => n.type === node.type);
    
    // å…ˆæ”¶é›†æ‰€æœ‰å­—æ®µçš„å½“å‰å€¼
    const currentValues = {};
    (nodeTemplate.config_schema || []).forEach(field => {
        const element = document.getElementById(`field_${field.name}`);
        if (!element) return;
        if (field.type === 'checkbox') {
            currentValues[field.name] = element.checked;
        } else {
            currentValues[field.name] = element.value;
        }
    });
    
    // ä¿å­˜å­—æ®µï¼Œå¹¶æ¸…ç†éšè—å­—æ®µçš„å€¼
    (nodeTemplate.config_schema || []).forEach(field => {
        const element = document.getElementById(`field_${field.name}`);
        if (!element) return;
        
        // æ£€æŸ¥å­—æ®µæ˜¯å¦åº”è¯¥æ˜¾ç¤ºï¼ˆæ ¹æ® show_if æ¡ä»¶ï¼‰
        let shouldSave = true;
        if (field.show_if) {
            for (const [key, expectedValue] of Object.entries(field.show_if)) {
                if (currentValues[key] !== expectedValue) {
                    shouldSave = false;
                    break;
                }
            }
        }
        
        if (shouldSave) {
            // ä¿å­˜å½“å‰å€¼
            node.config[field.name] = currentValues[field.name];
        } else {
            // æ¸…ç†éšè—å­—æ®µçš„å€¼ï¼ˆè®¾ä¸ºé»˜è®¤å€¼æˆ–ç©ºï¼‰
            node.config[field.name] = field.default !== undefined ? field.default : '';
        }
    });
    
    renderNodes();
}

function deleteNode(index) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹å—ï¼Ÿ')) {
        nodes.splice(index, 1);
        renderNodes();
    }
}

// åˆ‡æ¢é…ç½®é¡¹å±•å¼€/æŠ˜å 
function toggleConfigExpand(container, event) {
    event.stopPropagation();
    const full = container.querySelector('.config-full');
    const toggleText = container.querySelector('.config-toggle');
    const itemCount = full.children.length;
    
    if (full.style.display === 'none') {
        // å±•å¼€
        full.style.display = 'block';
        toggleText.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" style="vertical-align: -2px;"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6 -6l6 6" /></svg>
            æ”¶èµ·é…ç½®
        `;
    } else {
        // æŠ˜å 
        full.style.display = 'none';
        toggleText.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" style="vertical-align: -2px;"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg>
            å±•å¼€é…ç½® (${itemCount}é¡¹)
        `;
    }
}

// é€šç”¨ï¼šæ ¹æ® show_if æ¡ä»¶æ›´æ–°å­—æ®µæ˜¾ç¤º
function updateShowIfFields(currentValues) {
    // è·å–å½“å‰æ‰€æœ‰å­—æ®µçš„å€¼
    const allValues = {...currentValues};
    document.querySelectorAll('[id^="field_"]').forEach(el => {
        const fieldName = el.id.replace('field_', '');
        if (!(fieldName in allValues)) {
            allValues[fieldName] = el.type === 'checkbox' ? el.checked : el.value;
        }
    });
    
    // éå†æ‰€æœ‰å¸¦ data-show-if çš„å­—æ®µ
    document.querySelectorAll('[data-show-if]').forEach(el => {
        try {
            const condition = JSON.parse(el.getAttribute('data-show-if'));
            let shouldShow = true;
            
            // æ£€æŸ¥æ‰€æœ‰æ¡ä»¶
            for (const [key, expectedValue] of Object.entries(condition)) {
                if (allValues[key] !== expectedValue) {
                    shouldShow = false;
                    break;
                }
            }
            
            el.style.display = shouldShow ? 'block' : 'none';
        } catch (e) {
            console.error('show_if parse error:', e);
        }
    });
}

// æ¡ä»¶èŠ‚ç‚¹ï¼šæ ¹æ®æ¨¡å¼åˆ‡æ¢å­—æ®µæ˜¾ç¤º
function toggleConditionMode(mode) {
    // æŸ¥æ‰¾æ‰€æœ‰å¸¦æœ‰ data-condition-mode å±æ€§çš„å­—æ®µ
    const simpleFields = document.querySelectorAll('[data-condition-mode="simple"]');
    const advancedFields = document.querySelectorAll('[data-condition-mode="advanced"]');
    
    if (mode === 'simple') {
        // æ˜¾ç¤ºç®€å•æ¨¡å¼å­—æ®µï¼Œéšè—é«˜çº§æ¨¡å¼å­—æ®µ
        simpleFields.forEach(el => el.style.display = 'block');
        advancedFields.forEach(el => el.style.display = 'none');
    } else if (mode === 'advanced') {
        // éšè—ç®€å•æ¨¡å¼å­—æ®µï¼Œæ˜¾ç¤ºé«˜çº§æ¨¡å¼å­—æ®µ
        simpleFields.forEach(el => el.style.display = 'none');
        advancedFields.forEach(el => el.style.display = 'block');
    }
}

// å…¨å±€å˜é‡å­˜å‚¨ä»£ç ç‰‡æ®µæ•°æ®
let snippetsData = [];

// è¾…åŠ©å‡½æ•°ï¼šåŠ è½½ä»£ç ç‰‡æ®µåˆ—è¡¨
function loadSnippets(fieldName, currentValue) {
    fetch('/admin/workflows/snippets')
        .then(res => res.json())
        .then(data => {
            const selectEl = document.getElementById(`field_${fieldName}`);
            if (selectEl && data.success) {
                snippetsData = data.snippets;
                const options = data.snippets.map(s => 
                    `<option value="${s.filename}" ${currentValue === s.filename ? 'selected' : ''}>${s.name}</option>`
                ).join('');
                selectEl.innerHTML = `<option value="">è¯·é€‰æ‹©ä»£ç ç‰‡æ®µ</option>${options}`;
                
                // å¦‚æœæœ‰å½“å‰å€¼ï¼Œæ˜¾ç¤ºå…ƒæ•°æ®
                if (currentValue) {
                    showSnippetMetadata(currentValue);
                }
            }
        })
        .catch(console.error);
}

// æ˜¾ç¤ºä»£ç ç‰‡æ®µå…ƒæ•°æ®
function showSnippetMetadata(filename) {
    const metadataDiv = document.getElementById('snippet_metadata_info');
    if (!metadataDiv) return;
    
    if (!filename) {
        metadataDiv.style.display = 'none';
        return;
    }
    
    const snippet = snippetsData.find(s => s.filename === filename);
    if (snippet) {
        document.getElementById('snippet_filename').textContent = snippet.filename;
        document.getElementById('snippet_description').textContent = snippet.description || 'æ— ';
        document.getElementById('snippet_author').textContent = snippet.author || 'æœªçŸ¥';
        document.getElementById('snippet_version').textContent = snippet.version || '1.0.0';
        metadataDiv.style.display = 'block';
    } else {
        metadataDiv.style.display = 'none';
    }
}

// åŠ è½½è°ƒè¯•è®°å½•
function loadDebugRecord() {
    fetch(`/admin/workflows/${workflowId}/debug`)
        .then(res => res.json())
        .then(data => {
            if (data.success && data.record) {
                debugRecord = data.record;
                renderNodes();  // é‡æ–°æ¸²æŸ“èŠ‚ç‚¹ä»¥æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                showDebugSummary();
                showToast('å·²åŠ è½½è°ƒè¯•è®°å½•', 'success');
            } else {
                debugRecord = null;
                showToast(data.message || 'æš‚æ— è°ƒè¯•è®°å½•', 'warning');
            }
        })
        .catch(err => {
            console.error('åŠ è½½è°ƒè¯•è®°å½•å¤±è´¥:', err);
            showToast('åŠ è½½è°ƒè¯•è®°å½•å¤±è´¥', 'danger');
        });
}

// æ¸…é™¤è°ƒè¯•è®°å½•
function clearDebugRecord() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤è°ƒè¯•è®°å½•å—ï¼Ÿ')) return;
    
    fetch(`/admin/workflows/${workflowId}/debug/clear`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                debugRecord = null;
                renderNodes();
                hideDebugSummary();
                showToast('è°ƒè¯•è®°å½•å·²æ¸…é™¤', 'success');
            } else {
                showToast(data.message || 'æ¸…é™¤å¤±è´¥', 'danger');
            }
        })
        .catch(err => {
            console.error('æ¸…é™¤è°ƒè¯•è®°å½•å¤±è´¥:', err);
            showToast('æ¸…é™¤è°ƒè¯•è®°å½•å¤±è´¥', 'danger');
        });
}

// è·å–èŠ‚ç‚¹çš„è°ƒè¯•ä¿¡æ¯
function getNodeDebugInfo(nodeId) {
    if (!debugRecord || !debugRecord.nodes) return null;
    return debugRecord.nodes.find(n => n.id === nodeId);
}

// æ¸²æŸ“èŠ‚ç‚¹è°ƒè¯•ä¿¡æ¯
function renderDebugInfo(info) {
    if (!info) return '';
    
    const uid = 'debug_' + Math.random().toString(36).substr(2, 9);
    
    // çŠ¶æ€å’Œè€—æ—¶
    let statusHtml = info.status !== 'success' ? `<span class="badge bg-danger me-1">å¤±è´¥</span>` : '';
    const durationHtml = info.duration_ms !== undefined ? `<span class="text-muted">æ‰§è¡Œè€—æ—¶: ${info.duration_ms}ms</span>` : '';
    
    // æ£€æŸ¥æ•°æ®
    const hasInput = info.input && (typeof info.input === 'object' ? Object.keys(info.input).length > 0 : info.input);
    const hasOutput = info.output !== undefined && info.output !== null;
    const hasError = !!info.error;
    
    // æ„å»ºå†…å®¹
    let contentHtml = '';
    
    if (hasError) {
        contentHtml += `<div class="text-danger mb-2" style="font-size: 12px;"><strong>é”™è¯¯:</strong> ${escapeHtml(info.error)}</div>`;
    }
    
    if (hasInput) {
        contentHtml += `
            <details class="mb-2">
                <summary style="cursor:pointer; color:#206bc4; font-size:12px;">è¾“å…¥å˜é‡</summary>
                <pre class="bg-dark text-white p-2 mt-1 rounded" style="font-size:12px; max-height:300px; overflow:auto; white-space:pre-wrap; word-break:break-all;">${escapeHtml(formatDebugData(info.input))}</pre>
            </details>`;
    }
    
    if (hasOutput) {
        contentHtml += `
            <details class="mb-2" open>
                <summary style="cursor:pointer; color:#206bc4; font-size:12px;">è¾“å‡ºç»“æœ</summary>
                <pre class="bg-dark text-white p-2 mt-1 rounded" style="font-size:12px; max-height:300px; overflow:auto; white-space:pre-wrap; word-break:break-all;">${escapeHtml(formatDebugData(info.output))}</pre>
            </details>`;
    }
    
    if (!contentHtml) {
        return `<div style="margin: 8px 0 8px 24px; font-size: 12px;">${statusHtml}${durationHtml}</div>`;
    }
    
    return `
        <div style="margin: 8px 0 8px 24px; font-size: 12px;">
            <div class="mb-1">${statusHtml}${durationHtml}</div>
            ${contentHtml}
        </div>
    `;
}

// æ ¼å¼åŒ–è°ƒè¯•æ•°æ®
function formatDebugData(data) {
    if (data === null || data === undefined) return '';
    if (typeof data === 'string') {
        try {
            return JSON.stringify(JSON.parse(data), null, 2);
        } catch {
            return data;
        }
    }
    return JSON.stringify(data, null, 2);
}

// æ˜¾ç¤ºè°ƒè¯•æ‘˜è¦
function showDebugSummary() {
    if (!debugRecord) return;
    
    // ç§»é™¤æ—§çš„æ‘˜è¦
    hideDebugSummary();
    
    const statusBadge = debugRecord.status === 'success' 
        ? '<span class="badge bg-success-lt text-success">æˆåŠŸ</span>' 
        : '<span class="badge bg-danger-lt text-danger">å¤±è´¥</span>';
    const triggerMsg = debugRecord.trigger_message || '-';
    const nodeCount = debugRecord.nodes ? debugRecord.nodes.length : 0;
    const successCount = debugRecord.nodes ? debugRecord.nodes.filter(n => n.status === 'success').length : 0;
    
    const summaryHtml = `
        <div id="debugSummary" class="card card-sm mb-3">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">è°ƒè¯•è®°å½•</span>
                    <div>
                        ${statusBadge}
                        <a href="#" class="text-muted ms-2" onclick="clearDebugRecord(); return false;" title="æ¸…é™¤">Ã—</a>
                    </div>
                </div>
                <div class="text-muted" style="font-size:12px;">
                    <span class="me-3">æ—¶é—´: ${debugRecord.trigger_time || '-'}</span>
                    <span class="me-3">ç”¨æˆ·: ${debugRecord.user_id || '-'}</span>
                    <span class="me-3">ç¾¤: ${debugRecord.group_id || '-'}</span>
                    <span>èŠ‚ç‚¹: ${successCount}/${nodeCount}</span>
                </div>
                <details class="mt-2" style="font-size:12px;">
                    <summary style="cursor:pointer; color:#206bc4;">è§¦å‘æ¶ˆæ¯</summary>
                    <pre class="bg-dark text-white p-2 mt-1 rounded" style="font-size:12px; max-height:100px; overflow:auto; white-space:pre-wrap; word-break:break-all;">${escapeHtml(triggerMsg)}</pre>
                </details>
            </div>
        </div>
    `;
    
    document.getElementById('nodesList').insertAdjacentHTML('beforebegin', summaryHtml);
}

// éšè—è°ƒè¯•æ‘˜è¦
function hideDebugSummary() {
    const el = document.getElementById('debugSummary');
    if (el) el.remove();
}

// HTML è½¬ä¹‰
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

// ========== è¡¨å•æäº¤ ==========

function submitWorkflow(event) {
    event.preventDefault();
    
    // èŠ‚ç‚¹ä¸èƒ½ä¸ºç©º
    if (nodes.length === 0) {
        alert('å·¥ä½œæµèŠ‚ç‚¹ä¸èƒ½ä¸ºç©º');
        return;
    }
    
    // æ„å»ºå·¥ä½œæµèŠ‚ç‚¹é…ç½®ï¼ˆä¿ç•™åŸæœ‰ protocolsï¼‰
    const workflowConfig = {
        protocols: existingProtocols,
        workflow: nodes
    };
    
    const data = new FormData();
    data.append('workflow_data', JSON.stringify(workflowConfig));
    
    // é€šè¿‡è¡¨å•æäº¤
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = window.location.pathname;
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'workflow_data';
    input.value = JSON.stringify(workflowConfig);
    form.appendChild(input);
    
    document.body.appendChild(form);
    form.submit();
}
{% endraw %}
</script>
{% endblock %}