{% extends "admin/base.html" %}

{% block title %}åˆ›å»ºå·¥ä½œæµ - {{ system.title }}{% endblock %}
{% block page_title %}åˆ›å»ºå·¥ä½œæµ{% endblock %}

{% block content %}
<form id="workflowForm" onsubmit="submitWorkflow(event)">
    <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label required">æ’ä»¶åç§°</label>
                            <input type="text" class="form-control" name="name" required placeholder="ä¾‹å¦‚: æ¬¢è¿æ–°æˆå‘˜">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ä¼˜å…ˆçº§</label>
                            <input type="number" class="form-control" name="priority" value="100" min="0" max="999">
                            <small class="form-hint">æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">æè¿°</label>
                            <input type="text" class="form-control" name="description" placeholder="ç®€å•æè¿°è¿™ä¸ªæ’ä»¶çš„åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰">
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label required">è§¦å‘ç±»å‹</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-selectgroup-item">
                                        <input type="radio" name="trigger_type" value="message" class="form-selectgroup-input" checked onchange="toggleTriggerConfig()">
                                        <span class="form-selectgroup-label d-flex align-items-center p-3">
                                            <span class="me-3">
                                                <span class="form-selectgroup-check"></span>
                                            </span>
                                            <span class="form-selectgroup-label-content">
                                                <span class="form-selectgroup-title strong mb-1">ğŸ’¬ æ¶ˆæ¯è§¦å‘</span>
                                                <span class="d-block text-muted small">æ”¶åˆ°æ¶ˆæ¯æ—¶æ ¹æ®å…³é”®è¯è§¦å‘</span>
                                            </span>
                                        </span>
                                    </label>
                                </div>
                                <div class="col-6">
                                    <label class="form-selectgroup-item">
                                        <input type="radio" name="trigger_type" value="schedule" class="form-selectgroup-input" onchange="toggleTriggerConfig()">
                                        <span class="form-selectgroup-label d-flex align-items-center p-3">
                                            <span class="me-3">
                                                <span class="form-selectgroup-check"></span>
                                            </span>
                                            <span class="form-selectgroup-label-content">
                                                <span class="form-selectgroup-title strong mb-1">â° å®šæ—¶è§¦å‘</span>
                                                <span class="d-block text-muted small">æŒ‰è®¾å®šçš„æ—¶é—´è‡ªåŠ¨æ‰§è¡Œ</span>
                                            </span>
                                        </span>
                                    </label>
                                </div>
                            </div>
                            <small class="form-hint mt-2" id="triggerHint">
                                æ¶ˆæ¯è§¦å‘: å½“æœºå™¨äººæ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œæ ¹æ®è§¦å‘å™¨èŠ‚ç‚¹çš„å…³é”®è¯æˆ–æ¡ä»¶æ‰§è¡Œå·¥ä½œæµ
                            </small>
                        </div>
                        
                        <!-- å®šæ—¶é…ç½®ï¼ˆå†…è”ï¼‰ -->
                        <div class="col-md-6" id="scheduleTypeField" style="display: none;">
                            <label class="form-label required">è°ƒåº¦ç±»å‹</label>
                            <select class="form-select" name="schedule_type" id="scheduleType" onchange="toggleScheduleFields()">
                                <option value="cron">Cron è¡¨è¾¾å¼</option>
                                <option value="interval">å›ºå®šé—´éš”</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="cronField" style="display: none;">
                            <label class="form-label required">Cron è¡¨è¾¾å¼</label>
                            <input type="text" class="form-control" name="schedule_cron" value="0 8 * * *" placeholder="åˆ† æ—¶ æ—¥ æœˆ å‘¨">
                            <small class="form-hint">ä¾‹å¦‚ "0 8 * * *" è¡¨ç¤ºæ¯å¤© 08:00</small>
                        </div>
                        <div class="col-md-6" id="intervalField" style="display: none;">
                            <label class="form-label required">é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" class="form-control" name="schedule_interval" value="60" min="1" max="1440">
                            <small class="form-hint">1-1440 åˆ†é’Ÿ</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">åè®®é™åˆ¶</label>
                            <div>
                                <label class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="protocol_qq" value="qq">
                                    <span class="form-check-label">QQå®˜æ–¹</span>
                                </label>
                                <label class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="protocol_onebot" value="onebot">
                                    <span class="form-check-label">OneBot</span>
                                </label>
                            </div>
                            <small class="form-hint">ä¸é€‰åˆ™æ”¯æŒæ‰€æœ‰åè®®</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å¯ç”¨çŠ¶æ€</label>
                            <div class="mt-2">
                                <label class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="enabled" checked>
                                    <span class="form-check-label">åˆ›å»ºåç«‹å³å¯ç”¨</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <a href="{{ url_for('Admin.workflow_list') }}" class="btn btn-outline-secondary">å–æ¶ˆ</a>
                    <button type="submit" class="btn btn-primary">
                        <svg class="icon me-1" fill="none" height="16" stroke="currentColor" stroke-linecap="round"
                             stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M0 0h24v24H0z" fill="none" stroke="none"/>
                            <path d="M12 5l0 14"/>
                            <path d="M5 12l14 0"/>
                        </svg>
                        åˆ›å»ºå·¥ä½œæµ
                    </button>
                </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// è§¦å‘ç±»å‹åˆ‡æ¢
function toggleTriggerConfig() {
    const triggerType = document.querySelector('input[name="trigger_type"]:checked').value;
    const scheduleTypeField = document.getElementById('scheduleTypeField');
    const cronField = document.getElementById('cronField');
    const intervalField = document.getElementById('intervalField');
    const triggerHint = document.getElementById('triggerHint');
    
    if (triggerType === 'schedule') {
        scheduleTypeField.style.display = 'block';
        toggleScheduleFields(); // æ˜¾ç¤ºå¯¹åº”çš„ cron/interval å­—æ®µ
        triggerHint.textContent = 'å®šæ—¶è§¦å‘: æŒ‰è®¾å®šçš„æ—¶é—´è‡ªåŠ¨æ‰§è¡Œå·¥ä½œæµï¼Œåœ¨å·¥ä½œæµèŠ‚ç‚¹ä¸­é…ç½®å‘é€ç›®æ ‡';
    } else {
        scheduleTypeField.style.display = 'none';
        cronField.style.display = 'none';
        intervalField.style.display = 'none';
        triggerHint.textContent = 'æ¶ˆæ¯è§¦å‘: å½“æœºå™¨äººæ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œæ ¹æ®è§¦å‘å™¨èŠ‚ç‚¹çš„å…³é”®è¯æˆ–æ¡ä»¶æ‰§è¡Œå·¥ä½œæµ';
    }
}

// è°ƒåº¦ç±»å‹åˆ‡æ¢
function toggleScheduleFields() {
    const scheduleType = document.getElementById('scheduleType').value;
    const cronField = document.getElementById('cronField');
    const intervalField = document.getElementById('intervalField');
    
    if (scheduleType === 'cron') {
        cronField.style.display = 'block';
        intervalField.style.display = 'none';
    } else {
        cronField.style.display = 'none';
        intervalField.style.display = 'block';
    }
}

function submitWorkflow(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const triggerType = formData.get('trigger_type');
    
    // æ”¶é›†åè®®
    const protocols = [];
    if (formData.get('protocol_qq')) protocols.push('qq');
    if (formData.get('protocol_onebot')) protocols.push('onebot');
    
    const data = new FormData();
    data.append('name', formData.get('name'));
    data.append('description', formData.get('description') || '');
    data.append('enabled', formData.get('enabled') ? 'true' : 'false');
    data.append('priority', formData.get('priority') || '100');
    data.append('trigger_type', triggerType);
    data.append('protocols', JSON.stringify(protocols));
    
    if (triggerType === 'schedule') {
        const scheduleType = formData.get('schedule_type');
        data.append('schedule_type', scheduleType);
        if (scheduleType === 'cron') {
            data.append('schedule_cron', formData.get('schedule_cron') || '0 8 * * *');
        } else {
            data.append('schedule_interval', formData.get('schedule_interval') || '60');
        }
    }
    
    // é€šè¿‡è¡¨å•æäº¤
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/workflows/create';
    
    for (const [key, value] of data.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
